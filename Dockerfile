#############################
# –≠–¢–ê–ü 1: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
#############################

FROM python:3.11.8-slim AS banana
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    # –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –¥–ª—è C/C++ ‚Äî –Ω—É–∂–µ–Ω –¥–ª—è —Å–±–æ—Ä–∫–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    libpq-dev \
    # –î–ª—è PostgreSQL (psycopg2)
    libjpeg-dev \
    # –î–ª—è Pillow (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
    zlib1g-dev \          
    # –î–ª—è Pillow
    libwebp-dev \         
    # –î–ª—è Pillow (WebP)
    netcat \              
    # –î–ª—è healthcheck –∏–ª–∏ –æ–∂–∏–¥–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
    curl \                
    # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    && rm -rf /var/lib/apt/lists/*  
    # –û—á–∏—â–∞–µ–º –∫—ç—à apt –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

# –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç (–Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ —Ç—ã –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å .dockerignore, —á—Ç–æ–±—ã –Ω–µ —Ç–∞—â–∏—Ç—å –ª–∏—à–Ω–∏–µ —Ñ–∞–π–ª—ã)
COPY . .

# –î–µ–ª–∞–µ–º entrypoint.sh –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º, –±–µ–∑ /app/, —Ç–∞–∫ –∫–∞–∫ WORKDIR —É–∂–µ /app
RUN chmod +x entrypoint.sh  

#############################
# –≠–¢–ê–ü 2: –§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
#############################

FROM python:3.11.8-slim

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏–∑ builder
COPY --from=banana /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫, –Ω—É–∂–Ω—ã—Ö –≤ runtime (–≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ!)
RUN apt-get update && apt-get install -y \
    libpq5 \               
    # PostgreSQL runtime
    libjpeg62-turbo \      
    # Pillow runtime (JPEG)
    zlib1g \               
    # Pillow runtime (ZIP)
    libwebp6 \             
    # Pillow runtime (WebP)
    && rm -rf /var/lib/apt/lists/*

# –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ builder
COPY --from=banana /app .

# üéØ –£–¥–∞–ª—è—Ç—å –Ω–µ –Ω–∞–¥–æ, –µ—Å–ª–∏ —É —Ç–µ–±—è media/ —É–∂–µ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî —Ç—ã –º–æ–∂–µ—à—å **—Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å** –µ—ë –≤ docker-compose.
# –≠—Ç–æ—Ç RUN mkdir -p /app/media –±–µ–∑–æ–ø–∞—Å–µ–Ω ‚Äî –æ–Ω –Ω–∏—á–µ–≥–æ –Ω–µ –ª–æ–º–∞–µ—Ç. –ù–æ –º–æ–∂–Ω–æ **—É–±—Ä–∞—Ç—å**, –µ—Å–ª–∏ —É–≤–µ—Ä–µ–Ω, —á—Ç–æ media —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
# RUN mkdir -p /app/media && chmod -R 755 /app/media

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PYTHONHASHSEED=random \
    IMAGEIO_FFMPEG_EXE=/usr/bin/ffmpeg

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ ‚Äî —á–µ—Ä–µ–∑ shell-—Å–∫—Ä–∏–ø—Ç, –≥–¥–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏, collectstatic –∏ —Ç.–¥.
CMD ["sh", "entrypoint.sh"]
